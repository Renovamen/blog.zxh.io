(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{544:function(t,s,a){t.exports=a.p+"assets/img/positional-embedding.bbe028d1.png"},545:function(t,s,a){t.exports=a.p+"assets/img/wave.5fd3e2a1.png"},546:function(t,s,a){t.exports=a.p+"assets/img/multi-head-self-attention.6ff112a6.png"},547:function(t,s,a){t.exports=a.p+"assets/img/attention.8d27f0e6.png"},548:function(t,s,a){t.exports=a.p+"assets/img/encoder-decoder.cfe8e2a7.png"},549:function(t,s,a){t.exports=a.p+"assets/img/complexity.41666cb8.png"},648:function(t,s,a){"use strict";a.r(s);var i=a(55),e=Object(i.a)({},(function(){var t=this,s=t.$createElement,i=t._self._c||s;return i("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[i("p",[i("strong",[t._v("Attention Is All You Need.")]),t._v(" "),i("em",[t._v("Ashish Vaswani, et al.")]),t._v(" NIPS 2017. "),i("a",{attrs:{href:"https://papers.nips.cc/paper/7181-attention-is-all-you-need.pdf",target:"_blank",rel:"noopener noreferrer"}},[t._v("[Paper]")]),t._v(" "),i("a",{attrs:{href:"https://github.com/tensorflow/tensor2tensor/blob/master/tensor2tensor/models/transformer.py",target:"_blank",rel:"noopener noreferrer"}},[t._v("[Code]")])]),t._v(" "),i("p",[t._v("考虑到 RNN 只能单向依次计算，所以存在以下问题：")]),t._v(" "),i("ul",[i("li",[i("p",[i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("t")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("t")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.61508em","vertical-align":"0em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("t")])])])]),t._v(" 时刻的计算依赖与 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("t")]),i("mo",[t._v("−")]),i("mn",[t._v("1")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("t-1")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.69841em","vertical-align":"-0.08333em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("t")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}}),i("span",{staticClass:"mbin"},[t._v("−")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.64444em","vertical-align":"0em"}}),i("span",{staticClass:"mord"},[t._v("1")])])])]),t._v(" 时刻的计算结果，限制了模型的并行能力")])]),t._v(" "),i("li",[i("p",[t._v("RNN 的长期依赖问题")])])]),t._v(" "),i("p",[t._v("于是这篇论文扔掉了 encoder 和 decoder 中的 RNN 结构，完全用 attention 来搞 machine translation：")]),t._v(" "),i("ul",[i("li",[i("p",[t._v("没有 RNN 结构，所以有更好的并行能力")])]),t._v(" "),i("li",[i("p",[t._v("attention 机制对全局信息的处理更有效")])])]),t._v(" "),i("p",[t._v("Transformer 整体结构如下：")]),t._v(" "),i("img",{attrs:{src:"/img/in-post/2020-07-17/transformer.png",width:"400px",alt:"Transformer"}}),t._v(" "),i("h2",{attrs:{id:"position-embedding"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#position-embedding"}},[t._v("#")]),t._v(" Position Embedding")]),t._v(" "),i("p",[t._v("Transformer 扔掉了 RNN，对输入句子的所有单词都是同时处理的，所以失去了捕捉单词的排序和位置信息的能力。如果不解决词序的问题，那即使把一句话打乱，attention 出来的结果也是一样的，相当于这就只是一个词袋模型。为了解决这个问题，论文引入 position embedding 来对单词的位置信息进行编码。最终的输入词向量 = word embedding + position embedding：")]),t._v(" "),i("p",[i("img",{attrs:{src:a(544),alt:"Positional Embedding"}})]),t._v(" "),i("p",{staticClass:"desc"},[t._v("图片来源："),i("a",{attrs:{href:"http://jalammar.github.io/illustrated-transformer#representing-the-order-of-the-sequence-using-positional-encoding",target:"_blank"}},[t._v("The Illustrated Transformer")])]),t._v(" "),i("p",[t._v("有两种搞到 position embedding 的思路：")]),t._v(" "),i("ul",[i("li",[i("p",[t._v("学习出一份 position embedding（"),i("a",{attrs:{href:"http://proceedings.mlr.press/v70/gehring17a/gehring17a.pdf",target:"_blank",rel:"noopener noreferrer"}},[i("strong",[t._v("Convolutional Sequence to Sequence Learning")])]),t._v(". "),i("em",[t._v("Jonas Gehring et al.")]),t._v(" ICML 2017.）")])]),t._v(" "),i("li",[i("p",[t._v("直接用不同频率的 sin 和 cos 函数算出来")])])]),t._v(" "),i("p",[t._v("经过实验，论文发现这俩方法效果差不多，所以选了第二种方法，因为它有以下好处：")]),t._v(" "),i("ul",[i("li",[i("p",[t._v("不需要加额外的训练参数")])]),t._v(" "),i("li",[i("p",[t._v("学习出来的 position embedding 会受到训练集中序列的长度的限制，但三角函数明显不受序列长度的限制，所以能够处理训练集中没见过的序列长度")])])]),t._v(" "),i("p",[t._v("具体的位置编码公式为：")]),t._v(" "),i("p",[i("span",{staticClass:"katex-display"},[i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"}},[i("semantics",[i("mrow",[i("mi",[t._v("P")]),i("mi",[t._v("E")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mi",[t._v("p")]),i("mi",[t._v("o")]),i("mi",[t._v("s")]),i("mo",{attrs:{separator:"true"}},[t._v(",")]),i("mn",[t._v("2")]),i("mi",[t._v("i")]),i("mo",{attrs:{stretchy:"false"}},[t._v(")")]),i("mo",[t._v("=")]),i("mi",[t._v("sin")]),i("mo",[t._v("⁡")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mfrac",[i("mrow",[i("mi",[t._v("p")]),i("mi",[t._v("o")]),i("mi",[t._v("s")])],1),i("mrow",[i("mn",[t._v("1000")]),i("msup",[i("mn",[t._v("0")]),i("mfrac",[i("mrow",[i("mn",[t._v("2")]),i("mi",[t._v("i")])],1),i("msub",[i("mi",[t._v("d")]),i("mtext",[t._v("model")])],1)],1)],1)],1)],1),i("mo",{attrs:{stretchy:"false"}},[t._v(")")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("PE(pos, 2i) = \\sin(\\frac{pos}{10000^{\\frac{2i}{d_{\\text{model}}}}})\n")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.05764em"}},[t._v("PE")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord mathnormal"},[t._v("p")]),i("span",{staticClass:"mord mathnormal"},[t._v("os")]),i("span",{staticClass:"mpunct"},[t._v(",")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"mord"},[t._v("2")]),i("span",{staticClass:"mord mathnormal"},[t._v("i")]),i("span",{staticClass:"mclose"},[t._v(")")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}}),i("span",{staticClass:"mrel"},[t._v("=")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"2.11949em","vertical-align":"-1.01193em"}}),i("span",{staticClass:"mop"},[t._v("sin")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord"},[i("span",{staticClass:"mopen nulldelimiter"}),i("span",{staticClass:"mfrac"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"1.1075599999999999em"}},[i("span",{staticStyle:{top:"-2.11em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3.12193em"}}),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord"},[t._v("1000")]),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord"},[t._v("0")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"1.1219299999999999em"}},[i("span",{staticStyle:{top:"-3.5233700000000003em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mtight"},[i("span",{staticClass:"mord mtight"},[i("span",{staticClass:"mopen nulldelimiter sizing reset-size3 size6"}),i("span",{staticClass:"mfrac"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.8550857142857142em"}},[i("span",{staticStyle:{top:"-2.656em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3em"}}),i("span",{staticClass:"sizing reset-size3 size1 mtight"},[i("span",{staticClass:"mord mtight"},[i("span",{staticClass:"mord mtight"},[i("span",{staticClass:"mord mathnormal mtight"},[t._v("d")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.3448em"}},[i("span",{staticStyle:{top:"-2.3448em","margin-left":"0em","margin-right":"0.1em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.69444em"}}),i("span",{staticClass:"mord mtight"},[i("span",{staticClass:"mord text mtight"},[i("span",{staticClass:"mord mtight"},[t._v("model")])])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.34963999999999995em"}},[i("span")])])])])])])])]),i("span",{staticStyle:{top:"-3.2255000000000003em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3em"}}),i("span",{staticClass:"frac-line mtight",staticStyle:{"border-bottom-width":"0.049em"}})]),i("span",{staticStyle:{top:"-3.384em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3em"}}),i("span",{staticClass:"sizing reset-size3 size1 mtight"},[i("span",{staticClass:"mord mtight"},[i("span",{staticClass:"mord mtight"},[t._v("2")]),i("span",{staticClass:"mord mathnormal mtight"},[t._v("i")])])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.5937428571428571em"}},[i("span")])])])]),i("span",{staticClass:"mclose nulldelimiter sizing reset-size3 size6"})])])])])])])])])])])]),i("span",{staticStyle:{top:"-3.35193em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3.12193em"}}),i("span",{staticClass:"frac-line",staticStyle:{"border-bottom-width":"0.04em"}})]),i("span",{staticStyle:{top:"-3.79893em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3.12193em"}}),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal"},[t._v("p")]),i("span",{staticClass:"mord mathnormal"},[t._v("os")])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"1.01193em"}},[i("span")])])])]),i("span",{staticClass:"mclose nulldelimiter"})]),i("span",{staticClass:"mclose"},[t._v(")")])])])])])]),t._v(" "),i("p",[i("span",{staticClass:"katex-display"},[i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"}},[i("semantics",[i("mrow",[i("mi",[t._v("P")]),i("mi",[t._v("E")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mi",[t._v("p")]),i("mi",[t._v("o")]),i("mi",[t._v("s")]),i("mo",{attrs:{separator:"true"}},[t._v(",")]),i("mn",[t._v("2")]),i("mi",[t._v("i")]),i("mo",[t._v("+")]),i("mn",[t._v("1")]),i("mo",{attrs:{stretchy:"false"}},[t._v(")")]),i("mo",[t._v("=")]),i("mi",[t._v("cos")]),i("mo",[t._v("⁡")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mfrac",[i("mrow",[i("mi",[t._v("p")]),i("mi",[t._v("o")]),i("mi",[t._v("s")])],1),i("mrow",[i("mn",[t._v("1000")]),i("msup",[i("mn",[t._v("0")]),i("mfrac",[i("mrow",[i("mn",[t._v("2")]),i("mi",[t._v("i")])],1),i("msub",[i("mi",[t._v("d")]),i("mtext",[t._v("model")])],1)],1)],1)],1)],1),i("mo",{attrs:{stretchy:"false"}},[t._v(")")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("PE(pos, 2i+1) = \\cos(\\frac{pos}{10000^{\\frac{2i}{d_{\\text{model}}}}})\n")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.05764em"}},[t._v("PE")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord mathnormal"},[t._v("p")]),i("span",{staticClass:"mord mathnormal"},[t._v("os")]),i("span",{staticClass:"mpunct"},[t._v(",")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"mord"},[t._v("2")]),i("span",{staticClass:"mord mathnormal"},[t._v("i")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}}),i("span",{staticClass:"mbin"},[t._v("+")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mord"},[t._v("1")]),i("span",{staticClass:"mclose"},[t._v(")")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}}),i("span",{staticClass:"mrel"},[t._v("=")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"2.11949em","vertical-align":"-1.01193em"}}),i("span",{staticClass:"mop"},[t._v("cos")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord"},[i("span",{staticClass:"mopen nulldelimiter"}),i("span",{staticClass:"mfrac"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"1.1075599999999999em"}},[i("span",{staticStyle:{top:"-2.11em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3.12193em"}}),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord"},[t._v("1000")]),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord"},[t._v("0")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"1.1219299999999999em"}},[i("span",{staticStyle:{top:"-3.5233700000000003em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mtight"},[i("span",{staticClass:"mord mtight"},[i("span",{staticClass:"mopen nulldelimiter sizing reset-size3 size6"}),i("span",{staticClass:"mfrac"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.8550857142857142em"}},[i("span",{staticStyle:{top:"-2.656em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3em"}}),i("span",{staticClass:"sizing reset-size3 size1 mtight"},[i("span",{staticClass:"mord mtight"},[i("span",{staticClass:"mord mtight"},[i("span",{staticClass:"mord mathnormal mtight"},[t._v("d")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.3448em"}},[i("span",{staticStyle:{top:"-2.3448em","margin-left":"0em","margin-right":"0.1em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.69444em"}}),i("span",{staticClass:"mord mtight"},[i("span",{staticClass:"mord text mtight"},[i("span",{staticClass:"mord mtight"},[t._v("model")])])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.34963999999999995em"}},[i("span")])])])])])])])]),i("span",{staticStyle:{top:"-3.2255000000000003em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3em"}}),i("span",{staticClass:"frac-line mtight",staticStyle:{"border-bottom-width":"0.049em"}})]),i("span",{staticStyle:{top:"-3.384em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3em"}}),i("span",{staticClass:"sizing reset-size3 size1 mtight"},[i("span",{staticClass:"mord mtight"},[i("span",{staticClass:"mord mtight"},[t._v("2")]),i("span",{staticClass:"mord mathnormal mtight"},[t._v("i")])])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.5937428571428571em"}},[i("span")])])])]),i("span",{staticClass:"mclose nulldelimiter sizing reset-size3 size6"})])])])])])])])])])])]),i("span",{staticStyle:{top:"-3.35193em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3.12193em"}}),i("span",{staticClass:"frac-line",staticStyle:{"border-bottom-width":"0.04em"}})]),i("span",{staticStyle:{top:"-3.79893em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3.12193em"}}),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal"},[t._v("p")]),i("span",{staticClass:"mord mathnormal"},[t._v("os")])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"1.01193em"}},[i("span")])])])]),i("span",{staticClass:"mclose nulldelimiter"})]),i("span",{staticClass:"mclose"},[t._v(")")])])])])])]),t._v(" "),i("p",[t._v("其中 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("msub",[i("mi",[t._v("d")]),i("mtext",[t._v("model")])],1)],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("d_{\\text{model}}")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.84444em","vertical-align":"-0.15em"}}),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal"},[t._v("d")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.33610799999999996em"}},[i("span",{staticStyle:{top:"-2.5500000000000003em","margin-left":"0em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.7em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mtight"},[i("span",{staticClass:"mord text mtight"},[i("span",{staticClass:"mord mtight"},[t._v("model")])])])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.15em"}},[i("span")])])])])])])])]),t._v(" 为词嵌入维度（论文中为 512），pos 为该单词在序列中的位置，"),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mn",[t._v("2")]),i("mi",[t._v("i")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("2i")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.65952em","vertical-align":"0em"}}),i("span",{staticClass:"mord"},[t._v("2")]),i("span",{staticClass:"mord mathnormal"},[t._v("i")])])])]),t._v(" 为词向量的偶数维度（用第一个公式），"),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mn",[t._v("2")]),i("mi",[t._v("i")]),i("mo",[t._v("+")]),i("mn",[t._v("1")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("2i+1")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.74285em","vertical-align":"-0.08333em"}}),i("span",{staticClass:"mord"},[t._v("2")]),i("span",{staticClass:"mord mathnormal"},[t._v("i")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}}),i("span",{staticClass:"mbin"},[t._v("+")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.64444em","vertical-align":"0em"}}),i("span",{staticClass:"mord"},[t._v("1")])])])]),t._v(" 指词向量的奇数维度（用第二个公式）。波的频率和偏移对于每个维度是不同的：")]),t._v(" "),i("p",[i("img",{attrs:{src:a(545),alt:"wave"}})]),t._v(" "),i("p",{staticClass:"desc"},[t._v("图片来源："),i("a",{attrs:{href:"http://nlp.seas.harvard.edu/2018/04/03/attention.html#positional-encoding",target:"_blank"}},[t._v("The Annotated Transformer")])]),t._v(" "),i("p",[t._v("因为三角函数还有以下特性：")]),t._v(" "),i("p",[i("span",{staticClass:"katex-display"},[i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"}},[i("semantics",[i("mrow",[i("mi",[t._v("cos")]),i("mo",[t._v("⁡")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mi",[t._v("α")]),i("mo",[t._v("+")]),i("mi",[t._v("β")]),i("mo",{attrs:{stretchy:"false"}},[t._v(")")]),i("mo",[t._v("=")]),i("mi",[t._v("cos")]),i("mo",[t._v("⁡")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mi",[t._v("α")]),i("mo",{attrs:{stretchy:"false"}},[t._v(")")]),i("mi",[t._v("cos")]),i("mo",[t._v("⁡")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mi",[t._v("β")]),i("mo",{attrs:{stretchy:"false"}},[t._v(")")]),i("mo",[t._v("−")]),i("mi",[t._v("sin")]),i("mo",[t._v("⁡")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mi",[t._v("α")]),i("mo",{attrs:{stretchy:"false"}},[t._v(")")]),i("mi",[t._v("sin")]),i("mo",[t._v("⁡")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mi",[t._v("β")]),i("mo",{attrs:{stretchy:"false"}},[t._v(")")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("\\cos(\\alpha + \\beta) = \\cos(\\alpha) \\cos(\\beta) - \\sin(\\alpha) \\sin(\\beta)\n")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mop"},[t._v("cos")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.0037em"}},[t._v("α")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}}),i("span",{staticClass:"mbin"},[t._v("+")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.05278em"}},[t._v("β")]),i("span",{staticClass:"mclose"},[t._v(")")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}}),i("span",{staticClass:"mrel"},[t._v("=")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mop"},[t._v("cos")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.0037em"}},[t._v("α")]),i("span",{staticClass:"mclose"},[t._v(")")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"mop"},[t._v("cos")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.05278em"}},[t._v("β")]),i("span",{staticClass:"mclose"},[t._v(")")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}}),i("span",{staticClass:"mbin"},[t._v("−")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mop"},[t._v("sin")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.0037em"}},[t._v("α")]),i("span",{staticClass:"mclose"},[t._v(")")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"mop"},[t._v("sin")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.05278em"}},[t._v("β")]),i("span",{staticClass:"mclose"},[t._v(")")])])])])])]),t._v(" "),i("p",[i("span",{staticClass:"katex-display"},[i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"}},[i("semantics",[i("mrow",[i("mi",[t._v("sin")]),i("mo",[t._v("⁡")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mi",[t._v("α")]),i("mo",[t._v("+")]),i("mi",[t._v("β")]),i("mo",{attrs:{stretchy:"false"}},[t._v(")")]),i("mo",[t._v("=")]),i("mi",[t._v("sin")]),i("mo",[t._v("⁡")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mi",[t._v("α")]),i("mo",{attrs:{stretchy:"false"}},[t._v(")")]),i("mi",[t._v("cos")]),i("mo",[t._v("⁡")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mi",[t._v("β")]),i("mo",{attrs:{stretchy:"false"}},[t._v(")")]),i("mo",[t._v("+")]),i("mi",[t._v("cos")]),i("mo",[t._v("⁡")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mi",[t._v("α")]),i("mo",{attrs:{stretchy:"false"}},[t._v(")")]),i("mi",[t._v("sin")]),i("mo",[t._v("⁡")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mi",[t._v("β")]),i("mo",{attrs:{stretchy:"false"}},[t._v(")")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("\\sin(\\alpha + \\beta) = \\sin(\\alpha) \\cos(\\beta) + \\cos(\\alpha) \\sin(\\beta)\n")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mop"},[t._v("sin")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.0037em"}},[t._v("α")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}}),i("span",{staticClass:"mbin"},[t._v("+")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.05278em"}},[t._v("β")]),i("span",{staticClass:"mclose"},[t._v(")")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}}),i("span",{staticClass:"mrel"},[t._v("=")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mop"},[t._v("sin")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.0037em"}},[t._v("α")]),i("span",{staticClass:"mclose"},[t._v(")")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"mop"},[t._v("cos")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.05278em"}},[t._v("β")]),i("span",{staticClass:"mclose"},[t._v(")")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}}),i("span",{staticClass:"mbin"},[t._v("+")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mop"},[t._v("cos")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.0037em"}},[t._v("α")]),i("span",{staticClass:"mclose"},[t._v(")")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"mop"},[t._v("sin")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.05278em"}},[t._v("β")]),i("span",{staticClass:"mclose"},[t._v(")")])])])])])]),t._v(" "),i("p",[t._v("所以任意位置的 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("P")]),i("mi",[t._v("E")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mi",[t._v("p")]),i("mi",[t._v("o")]),i("mi",[t._v("s")]),i("mo",[t._v("+")]),i("mi",[t._v("k")]),i("mo",{attrs:{stretchy:"false"}},[t._v(")")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("PE(pos+k)")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.05764em"}},[t._v("PE")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord mathnormal"},[t._v("p")]),i("span",{staticClass:"mord mathnormal"},[t._v("os")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}}),i("span",{staticClass:"mbin"},[t._v("+")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.03148em"}},[t._v("k")]),i("span",{staticClass:"mclose"},[t._v(")")])])])]),t._v(" 都能通过 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("P")]),i("mi",[t._v("E")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mi",[t._v("p")]),i("mi",[t._v("o")]),i("mi",[t._v("s")]),i("mo",{attrs:{stretchy:"false"}},[t._v(")")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("PE(pos)")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.05764em"}},[t._v("PE")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord mathnormal"},[t._v("p")]),i("span",{staticClass:"mord mathnormal"},[t._v("os")]),i("span",{staticClass:"mclose"},[t._v(")")])])])]),t._v(" 线性表达，这为模型捕捉单词之间的相对位置关系提供了非常大的便利。")]),t._v(" "),i("h2",{attrs:{id:"encoder"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#encoder"}},[t._v("#")]),t._v(" Encoder")]),t._v(" "),i("p",[t._v("论文中的 encoder 由 N = 6 个相同的 layer 堆叠而成：")]),t._v(" "),i("img",{attrs:{src:"/img/in-post/2020-07-17/encoder.png",width:"180px",alt:"encoder"}}),t._v(" "),i("p",[t._v("每个 layer 由两个 sub-layer 组成，分别为 multi-head self-attention 和 fully connected feed-forward network。")]),t._v(" "),i("p",[t._v("并且每个 sub-layer 都加了：")]),t._v(" "),i("ul",[i("li",[i("p",[t._v("Residual Connection：解决多层神经网络训练困难的问题，通过将前一层的信息无差的传递到下一层，可以有效的仅关注差异部分")])]),t._v(" "),i("li",[i("p",[t._v("Layer Normalisation：对层的激活值进行归一化，可以加速模型的训练过程，使其更快的收敛")]),t._v(" "),i("p",[i("a",{attrs:{href:"https://arxiv.org/pdf/1607.06450.pdf",target:"_blank",rel:"noopener noreferrer"}},[i("strong",[t._v("Layer Normalization")])]),t._v(". "),i("em",[t._v("Jimmy Lei Ba, et al.")]),t._v(" arXiv 2016.")])])]),t._v(" "),i("p",[t._v("也就是输入会先进 LayerNorm，再进 sub-layer，然后加在原始输入上（虽然图上 LayerNorm 似乎在 sub-layer 后面，但"),i("a",{attrs:{href:"http://nlp.seas.harvard.edu/2018/04/03/attention.html#encoder",target:"_blank",rel:"noopener noreferrer"}},[t._v("代码")]),t._v("里的确是先进 LayerNorm）。最后 6 个 layer 都跑完之后还要再单独 norm 一次（虽然图上没画但"),i("a",{attrs:{href:"http://nlp.seas.harvard.edu/2018/04/03/attention.html#encoder",target:"_blank",rel:"noopener noreferrer"}},[t._v("代码")]),t._v("里写了）。")]),t._v(" "),i("h3",{attrs:{id:"muti-head-self-attention"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#muti-head-self-attention"}},[t._v("#")]),t._v(" Muti-Head Self-Attention")]),t._v(" "),i("p",[t._v("attention 可以表示为以下形式：")]),t._v(" "),i("p",[i("span",{staticClass:"katex-display"},[i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"}},[i("semantics",[i("mrow",[i("mi",[t._v("a")]),i("mi",[t._v("t")]),i("mi",[t._v("t")]),i("mi",{attrs:{mathvariant:"normal"}},[t._v("_")]),i("mi",[t._v("o")]),i("mi",[t._v("u")]),i("mi",[t._v("t")]),i("mo",[t._v("=")]),i("mtext",[t._v("Attention")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mi",[t._v("Q")]),i("mo",{attrs:{separator:"true"}},[t._v(",")]),i("mi",[t._v("K")]),i("mo",{attrs:{separator:"true"}},[t._v(",")]),i("mi",[t._v("V")]),i("mo",{attrs:{stretchy:"false"}},[t._v(")")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("att\\_out = \\text{Attention}(Q, K, V)\n")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.9250799999999999em","vertical-align":"-0.31em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("a")]),i("span",{staticClass:"mord mathnormal"},[t._v("tt")]),i("span",{staticClass:"mord",staticStyle:{"margin-right":"0.02778em"}},[t._v("_")]),i("span",{staticClass:"mord mathnormal"},[t._v("o")]),i("span",{staticClass:"mord mathnormal"},[t._v("u")]),i("span",{staticClass:"mord mathnormal"},[t._v("t")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}}),i("span",{staticClass:"mrel"},[t._v("=")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mord text"},[i("span",{staticClass:"mord"},[t._v("Attention")])]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord mathnormal"},[t._v("Q")]),i("span",{staticClass:"mpunct"},[t._v(",")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07153em"}},[t._v("K")]),i("span",{staticClass:"mpunct"},[t._v(",")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("V")]),i("span",{staticClass:"mclose"},[t._v(")")])])])])])]),t._v(" "),i("p",[t._v("其中 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("V")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("V")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("V")])])])]),t._v("（value）用来求加权和得到最终的上下文向量，而 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("Q")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("Q")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.8777699999999999em","vertical-align":"-0.19444em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("Q")])])])]),t._v("（query）和所有的 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("K")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("K")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07153em"}},[t._v("K")])])])]),t._v("（key）会被用来计算注意力权重。如在传统的 seq2seq 结构中，它们分别由以下值经过线性变换得到：")]),t._v(" "),i("ul",[i("li",[i("p",[i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("Q")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("Q")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.8777699999999999em","vertical-align":"-0.19444em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("Q")])])])]),t._v("：decoder 的当前输入")])]),t._v(" "),i("li",[i("p",[i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("V")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("V")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("V")])])])]),t._v("：encoder 的输出（"),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("msub",[i("mi",[t._v("h")]),i("mn",[t._v("1")])],1),i("mo",{attrs:{separator:"true"}},[t._v(",")]),i("msub",[i("mi",[t._v("h")]),i("mn",[t._v("2")])],1),i("mo",{attrs:{separator:"true"}},[t._v(",")]),i("mo",[t._v("…")]),i("mo",{attrs:{separator:"true"}},[t._v(",")]),i("msub",[i("mi",[t._v("h")]),i("mi",[t._v("n")])],1)],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("h_1, h_2, \\dots, h_n")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.8888799999999999em","vertical-align":"-0.19444em"}}),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal"},[t._v("h")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.30110799999999993em"}},[i("span",{staticStyle:{top:"-2.5500000000000003em","margin-left":"0em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.7em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mtight"},[t._v("1")])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.15em"}},[i("span")])])])])]),i("span",{staticClass:"mpunct"},[t._v(",")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal"},[t._v("h")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.30110799999999993em"}},[i("span",{staticStyle:{top:"-2.5500000000000003em","margin-left":"0em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.7em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mtight"},[t._v("2")])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.15em"}},[i("span")])])])])]),i("span",{staticClass:"mpunct"},[t._v(",")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"minner"},[t._v("…")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"mpunct"},[t._v(",")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal"},[t._v("h")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.151392em"}},[i("span",{staticStyle:{top:"-2.5500000000000003em","margin-left":"0em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.7em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mathnormal mtight"},[t._v("n")])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.15em"}},[i("span")])])])])])])])]),t._v("）")])]),t._v(" "),i("li",[i("p",[i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("K")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("K")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07153em"}},[t._v("K")])])])]),t._v("：同 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("V")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("V")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("V")])])])])])])]),t._v(" "),i("p",[t._v("而这里是 self-attention，所以 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("Q")]),i("mo",{attrs:{separator:"true"}},[t._v(",")]),i("mi",[t._v("V")]),i("mo",{attrs:{separator:"true"}},[t._v(",")]),i("mi",[t._v("K")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("Q, V, K")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.8777699999999999em","vertical-align":"-0.19444em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("Q")]),i("span",{staticClass:"mpunct"},[t._v(",")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("V")]),i("span",{staticClass:"mpunct"},[t._v(",")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07153em"}},[t._v("K")])])])]),t._v(" 由同一个值 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("x")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("x")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.43056em","vertical-align":"0em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("x")])])])]),t._v(" 经过线性变换得到，"),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("x")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("x")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.43056em","vertical-align":"0em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("x")])])])]),t._v(" 在第一个 layer 为输入的词向量序列，在之后的 layer 则为上一个 layer 的输出。")]),t._v(" "),i("p",[t._v("而 multi-head attention 就是通过 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("h")]),i("mo",[t._v("=")]),i("mn",[t._v("8")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("h=8")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.69444em","vertical-align":"0em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("h")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}}),i("span",{staticClass:"mrel"},[t._v("=")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.64444em","vertical-align":"0em"}}),i("span",{staticClass:"mord"},[t._v("8")])])])]),t._v(" 个不同的线性变换得到不同的 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("Q")]),i("mo",{attrs:{separator:"true"}},[t._v(",")]),i("mi",[t._v("V")]),i("mo",{attrs:{separator:"true"}},[t._v(",")]),i("mi",[t._v("K")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("Q, V, K")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.8777699999999999em","vertical-align":"-0.19444em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("Q")]),i("span",{staticClass:"mpunct"},[t._v(",")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("V")]),i("span",{staticClass:"mpunct"},[t._v(",")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07153em"}},[t._v("K")])])])]),t._v("，最后将这 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("h")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("h")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.69444em","vertical-align":"0em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("h")])])])]),t._v(" 个 attention 结果拼接起来：")]),t._v(" "),i("p",[i("img",{attrs:{src:a(546),alt:"multi-head sekf-attention"}})]),t._v(" "),i("p",{staticClass:"desc"},[t._v("图片来源："),i("a",{attrs:{href:"http://jalammar.github.io/illustrated-transformer#the-beast-with-many-heads",target:"_blank"}},[t._v("The Illustrated Transformer")])]),t._v(" "),i("p",[t._v("这里的 attention 计算公式为（scaled dot-product）：")]),t._v(" "),i("p",[i("span",{staticClass:"katex-display"},[i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"}},[i("semantics",[i("mrow",[i("mtext",[t._v("Attention")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mi",[t._v("Q")]),i("mo",{attrs:{separator:"true"}},[t._v(",")]),i("mi",[t._v("K")]),i("mo",{attrs:{separator:"true"}},[t._v(",")]),i("mi",[t._v("V")]),i("mo",{attrs:{stretchy:"false"}},[t._v(")")]),i("mo",[t._v("=")]),i("mtext",[t._v("softmax")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mfrac",[i("mrow",[i("mi",[t._v("Q")]),i("msup",[i("mi",[t._v("K")]),i("mi",[t._v("T")])],1)],1),i("msqrt",[i("msub",[i("mi",[t._v("d")]),i("mi",[t._v("k")])],1)],1)],1),i("mo",{attrs:{stretchy:"false"}},[t._v(")")]),i("mi",[t._v("V")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("\\text{Attention}(Q, K, V) = \\text{softmax}(\\frac{QK^T}{\\sqrt{d_k}}) V\n")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mord text"},[i("span",{staticClass:"mord"},[t._v("Attention")])]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord mathnormal"},[t._v("Q")]),i("span",{staticClass:"mpunct"},[t._v(",")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07153em"}},[t._v("K")]),i("span",{staticClass:"mpunct"},[t._v(",")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("V")]),i("span",{staticClass:"mclose"},[t._v(")")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}}),i("span",{staticClass:"mrel"},[t._v("=")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"2.448331em","vertical-align":"-0.93em"}}),i("span",{staticClass:"mord text"},[i("span",{staticClass:"mord"},[t._v("softmax")])]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord"},[i("span",{staticClass:"mopen nulldelimiter"}),i("span",{staticClass:"mfrac"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"1.5183309999999999em"}},[i("span",{staticStyle:{top:"-2.25278em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3em"}}),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord sqrt"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.85722em"}},[i("span",{staticClass:"svg-align",staticStyle:{top:"-3em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3em"}}),i("span",{staticClass:"mord",staticStyle:{"padding-left":"0.833em"}},[i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal"},[t._v("d")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.33610799999999996em"}},[i("span",{staticStyle:{top:"-2.5500000000000003em","margin-left":"0em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.7em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mathnormal mtight",staticStyle:{"margin-right":"0.03148em"}},[t._v("k")])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.15em"}},[i("span")])])])])])])]),i("span",{staticStyle:{top:"-2.81722em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3em"}}),i("span",{staticClass:"hide-tail",staticStyle:{"min-width":"0.853em",height:"1.08em"}},[i("svg",{attrs:{width:"400em",height:"1.08em",viewBox:"0 0 400000 1080",preserveAspectRatio:"xMinYMin slice"}},[i("path",{attrs:{d:"M95,702\nc-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14\nc0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54\nc44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10\ns173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429\nc69,-144,104.5,-217.7,106.5,-221\nl0 -0\nc5.3,-9.3,12,-14,20,-14\nH400000v40H845.2724\ns-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7\nc-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z\nM834 80h400000v40h-400000z"}})])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.18278000000000005em"}},[i("span")])])])])])]),i("span",{staticStyle:{top:"-3.23em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3em"}}),i("span",{staticClass:"frac-line",staticStyle:{"border-bottom-width":"0.04em"}})]),i("span",{staticStyle:{top:"-3.677em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3em"}}),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal"},[t._v("Q")]),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07153em"}},[t._v("K")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.8413309999999999em"}},[i("span",{staticStyle:{top:"-3.063em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.7em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mathnormal mtight",staticStyle:{"margin-right":"0.13889em"}},[t._v("T")])])])])])])])])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.93em"}},[i("span")])])])]),i("span",{staticClass:"mclose nulldelimiter"})]),i("span",{staticClass:"mclose"},[t._v(")")]),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("V")])])])])])]),t._v(" "),i("p",[t._v("注意：这里跟 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("V")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("V")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("V")])])])]),t._v(" 是"),i("strong",[t._v("矩阵相乘")]),t._v("，不是 element-wise 相乘。")]),t._v(" "),i("p",[i("img",{attrs:{src:a(547),alt:"attention"}})]),t._v(" "),i("p",[t._v("其中 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("msub",[i("mi",[t._v("d")]),i("mi",[t._v("k")])],1),i("mo",[t._v("=")]),i("msub",[i("mi",[t._v("d")]),i("mtext",[t._v("model")])],1),i("mi",{attrs:{mathvariant:"normal"}},[t._v("/")]),i("mi",[t._v("h")]),i("mo",[t._v("=")]),i("mn",[t._v("512")]),i("mi",{attrs:{mathvariant:"normal"}},[t._v("/")]),i("mn",[t._v("8")]),i("mo",[t._v("=")]),i("mn",[t._v("64")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("d_k = d_{\\text{model}} / h = 512 / 8 = 64")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.84444em","vertical-align":"-0.15em"}}),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal"},[t._v("d")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.33610799999999996em"}},[i("span",{staticStyle:{top:"-2.5500000000000003em","margin-left":"0em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.7em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mathnormal mtight",staticStyle:{"margin-right":"0.03148em"}},[t._v("k")])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.15em"}},[i("span")])])])])]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}}),i("span",{staticClass:"mrel"},[t._v("=")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal"},[t._v("d")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.33610799999999996em"}},[i("span",{staticStyle:{top:"-2.5500000000000003em","margin-left":"0em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.7em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mtight"},[i("span",{staticClass:"mord text mtight"},[i("span",{staticClass:"mord mtight"},[t._v("model")])])])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.15em"}},[i("span")])])])])]),i("span",{staticClass:"mord"},[t._v("/")]),i("span",{staticClass:"mord mathnormal"},[t._v("h")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}}),i("span",{staticClass:"mrel"},[t._v("=")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mord"},[t._v("512/8")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}}),i("span",{staticClass:"mrel"},[t._v("=")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.64444em","vertical-align":"0em"}}),i("span",{staticClass:"mord"},[t._v("64")])])])]),t._v("。除以 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("msqrt",[i("msub",[i("mi",[t._v("d")]),i("mi",[t._v("k")])],1)],1)],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("\\sqrt{d_k}")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1.04em","vertical-align":"-0.18278000000000005em"}}),i("span",{staticClass:"mord sqrt"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.85722em"}},[i("span",{staticClass:"svg-align",staticStyle:{top:"-3em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3em"}}),i("span",{staticClass:"mord",staticStyle:{"padding-left":"0.833em"}},[i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal"},[t._v("d")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.33610799999999996em"}},[i("span",{staticStyle:{top:"-2.5500000000000003em","margin-left":"0em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.7em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mathnormal mtight",staticStyle:{"margin-right":"0.03148em"}},[t._v("k")])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.15em"}},[i("span")])])])])])])]),i("span",{staticStyle:{top:"-2.81722em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3em"}}),i("span",{staticClass:"hide-tail",staticStyle:{"min-width":"0.853em",height:"1.08em"}},[i("svg",{attrs:{width:"400em",height:"1.08em",viewBox:"0 0 400000 1080",preserveAspectRatio:"xMinYMin slice"}},[i("path",{attrs:{d:"M95,702\nc-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14\nc0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54\nc44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10\ns173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429\nc69,-144,104.5,-217.7,106.5,-221\nl0 -0\nc5.3,-9.3,12,-14,20,-14\nH400000v40H845.2724\ns-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7\nc-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z\nM834 80h400000v40h-400000z"}})])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.18278000000000005em"}},[i("span")])])])])])])]),t._v(" 是因为，"),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("msub",[i("mi",[t._v("d")]),i("mi",[t._v("k")])],1)],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("d_k")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.84444em","vertical-align":"-0.15em"}}),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal"},[t._v("d")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.33610799999999996em"}},[i("span",{staticStyle:{top:"-2.5500000000000003em","margin-left":"0em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.7em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mathnormal mtight",staticStyle:{"margin-right":"0.03148em"}},[t._v("k")])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.15em"}},[i("span")])])])])])])])]),t._v(" 越大 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("Q")]),i("msup",[i("mi",[t._v("K")]),i("mi",[t._v("T")])],1)],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("QK^T")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1.035771em","vertical-align":"-0.19444em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("Q")]),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07153em"}},[t._v("K")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.8413309999999999em"}},[i("span",{staticStyle:{top:"-3.063em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.7em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mathnormal mtight",staticStyle:{"margin-right":"0.13889em"}},[t._v("T")])])])])])])])])])])]),t._v(" 就会越大，可能就会将 softmax 函数推入梯度极小的区域，所以要用 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("msqrt",[i("msub",[i("mi",[t._v("d")]),i("mi",[t._v("k")])],1)],1)],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("\\sqrt{d_k}")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1.04em","vertical-align":"-0.18278000000000005em"}}),i("span",{staticClass:"mord sqrt"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.85722em"}},[i("span",{staticClass:"svg-align",staticStyle:{top:"-3em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3em"}}),i("span",{staticClass:"mord",staticStyle:{"padding-left":"0.833em"}},[i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal"},[t._v("d")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.33610799999999996em"}},[i("span",{staticStyle:{top:"-2.5500000000000003em","margin-left":"0em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.7em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mathnormal mtight",staticStyle:{"margin-right":"0.03148em"}},[t._v("k")])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.15em"}},[i("span")])])])])])])]),i("span",{staticStyle:{top:"-2.81722em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"3em"}}),i("span",{staticClass:"hide-tail",staticStyle:{"min-width":"0.853em",height:"1.08em"}},[i("svg",{attrs:{width:"400em",height:"1.08em",viewBox:"0 0 400000 1080",preserveAspectRatio:"xMinYMin slice"}},[i("path",{attrs:{d:"M95,702\nc-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14\nc0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54\nc44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10\ns173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429\nc69,-144,104.5,-217.7,106.5,-221\nl0 -0\nc5.3,-9.3,12,-14,20,-14\nH400000v40H845.2724\ns-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7\nc-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z\nM834 80h400000v40h-400000z"}})])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.18278000000000005em"}},[i("span")])])])])])])]),t._v(" 对 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("Q")]),i("msup",[i("mi",[t._v("K")]),i("mi",[t._v("T")])],1)],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("QK^T")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1.035771em","vertical-align":"-0.19444em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("Q")]),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07153em"}},[t._v("K")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.8413309999999999em"}},[i("span",{staticStyle:{top:"-3.063em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.7em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mathnormal mtight",staticStyle:{"margin-right":"0.13889em"}},[t._v("T")])])])])])])])])])])]),t._v(" 进行缩放。")]),t._v(" "),i("p",[t._v("图中的 mask 只会在 "),i("a",{attrs:{href:"#masked-multi-head-self-attention"}},[t._v("decoder")]),t._v(" 中被用到。")]),t._v(" "),i("h3",{attrs:{id:"feed-forward-network"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#feed-forward-network"}},[t._v("#")]),t._v(" Feed-Forward Network")]),t._v(" "),i("p",[t._v("第二个 sub-layer 是一个前馈网络：")]),t._v(" "),i("p",[i("span",{staticClass:"katex-display"},[i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"}},[i("semantics",[i("mrow",[i("mtext",[t._v("FFN")]),i("mo",[t._v("=")]),i("mi",[t._v("max")]),i("mo",[t._v("⁡")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mn",[t._v("0")]),i("mo",{attrs:{separator:"true"}},[t._v(",")]),i("mi",[t._v("x")]),i("msub",[i("mi",[t._v("W")]),i("mn",[t._v("1")])],1),i("mo",[t._v("+")]),i("msub",[i("mi",[t._v("b")]),i("mn",[t._v("1")])],1),i("mo",{attrs:{stretchy:"false"}},[t._v(")")]),i("msub",[i("mi",[t._v("W")]),i("mn",[t._v("2")])],1),i("mo",[t._v("+")]),i("msub",[i("mi",[t._v("b")]),i("mn",[t._v("2")])],1)],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("\\text{FFN} = \\max(0, xW_1 + b_1) W_2 + b_2\n")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),i("span",{staticClass:"mord text"},[i("span",{staticClass:"mord"},[t._v("FFN")])]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}}),i("span",{staticClass:"mrel"},[t._v("=")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mop"},[t._v("max")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord"},[t._v("0")]),i("span",{staticClass:"mpunct"},[t._v(",")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("x")]),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.13889em"}},[t._v("W")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.30110799999999993em"}},[i("span",{staticStyle:{top:"-2.5500000000000003em","margin-left":"-0.13889em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.7em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mtight"},[t._v("1")])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.15em"}},[i("span")])])])])]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}}),i("span",{staticClass:"mbin"},[t._v("+")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal"},[t._v("b")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.30110799999999993em"}},[i("span",{staticStyle:{top:"-2.5500000000000003em","margin-left":"0em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.7em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mtight"},[t._v("1")])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.15em"}},[i("span")])])])])]),i("span",{staticClass:"mclose"},[t._v(")")]),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.13889em"}},[t._v("W")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.30110799999999993em"}},[i("span",{staticStyle:{top:"-2.5500000000000003em","margin-left":"-0.13889em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.7em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mtight"},[t._v("2")])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.15em"}},[i("span")])])])])]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}}),i("span",{staticClass:"mbin"},[t._v("+")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.84444em","vertical-align":"-0.15em"}}),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal"},[t._v("b")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t vlist-t2"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.30110799999999993em"}},[i("span",{staticStyle:{top:"-2.5500000000000003em","margin-left":"0em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.7em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mtight"},[t._v("2")])])])]),i("span",{staticClass:"vlist-s"},[t._v("​")])]),i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.15em"}},[i("span")])])])])])])])])])]),t._v(" "),i("h2",{attrs:{id:"decoder"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#decoder"}},[t._v("#")]),t._v(" Decoder")]),t._v(" "),i("p",[t._v("encoder-decoder 结构：")]),t._v(" "),i("p",[i("img",{attrs:{src:a(548),alt:"encoder-decoder"}})]),t._v(" "),i("p",{staticClass:"desc"},[t._v("图片来源："),i("a",{attrs:{href:"http://jalammar.github.io/illustrated-transformer#the-residuals",target:"_blank"}},[t._v("The Illustrated Transformer")])]),t._v(" "),i("p",[i("a",{attrs:{href:"http://jalammar.github.io/illustrated-transformer#the-decoder-side",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里")]),t._v("还有两个清楚的解释了 encoder 和 decoder 的工作方式的动画。")]),t._v(" "),i("p",[t._v("decoder 也由 N = 6 个相同的 layer 堆叠而成，每个 layer 由三个 sub-layer 组成：")]),t._v(" "),i("img",{attrs:{src:"/img/in-post/2020-07-17/decoder.png",width:"180px",alt:"decoder"}}),t._v(" "),i("h3",{attrs:{id:"masked-multi-head-self-attention"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#masked-multi-head-self-attention"}},[t._v("#")]),t._v(" Masked Multi-Head Self-Attention")]),t._v(" "),i("p",[t._v("在训练时，decoder 在预测第 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("i")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("i")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.65952em","vertical-align":"0em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("i")])])])]),t._v(" 个位置时不应该看到未来的信息，但 self-attention 机制能让它看到全局信息（标签泄露）。所以会对在 self-attention 的 softmax 层前加 mask，将未来信息屏蔽掉。")]),t._v(" "),i("p",[t._v("mask 是一个下三角矩阵，对角线以及对角线左下都是1，其余都是0：")]),t._v(" "),i("img",{attrs:{src:"/img/in-post/2020-07-17/mask.png",width:"300px",alt:"mask"}}),t._v(" "),i("p",{staticClass:"desc"},[t._v("mask 矩阵，蓝色部分是 1，白色部分是 0（图片来源："),i("a",{attrs:{href:"https://spaces.ac.cn/archives/6933#单向语言模型",target:"_blank"}},[t._v("从语言模型到 Seq2Seq：Transformer 如戏，全靠 Mask")]),t._v("）")]),t._v(" "),i("p",[t._v("矩阵的行为当前预测到第几个单词，列为当前允许看到前几个位置的信息。然后 mask=0 的位置上的元素会都被替换为 "),i("code",[t._v("-inf")]),t._v("。")]),t._v(" "),i("h3",{attrs:{id:"multi-head-attention"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#multi-head-attention"}},[t._v("#")]),t._v(" Multi-head Attention")]),t._v(" "),i("p",[t._v("即论文 3.2.3 节中的 encoder-decoder attention。它的 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("Q")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("Q")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.8777699999999999em","vertical-align":"-0.19444em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("Q")])])])]),t._v(" 来自于上一位置的 decoder 的输出（第一个 layer）或上一个 decoder layer 的输出（之后的 layer），而 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("K")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("K")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07153em"}},[t._v("K")])])])]),t._v(" 和 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("V")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("V")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("V")])])])]),t._v(" 来自于 encoder 的输出。这让 decoder 的每一个位置都可以看到到输入序列的全局信息。")]),t._v(" "),i("p",[t._v("编码可以并行计算，但解码时，因为需要上一时刻的输出当作 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("Q")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("Q")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.8777699999999999em","vertical-align":"-0.19444em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("Q")])])])]),t._v("，所以无法并行计算。")]),t._v(" "),i("h3",{attrs:{id:"feed-forward-network-2"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#feed-forward-network-2"}},[t._v("#")]),t._v(" Feed-Forward Network")]),t._v(" "),i("p",[t._v("同 encoder。")]),t._v(" "),i("h2",{attrs:{id:"summary"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#summary"}},[t._v("#")]),t._v(" Summary")]),t._v(" "),i("p",[t._v("优点：")]),t._v(" "),i("ul",[i("li",[i("p",[t._v("相比其他方法，当序列长度 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("n")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("n")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.43056em","vertical-align":"0em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("n")])])])]),t._v(" 小于词向量维度 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("d")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("d")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.69444em","vertical-align":"0em"}}),i("span",{staticClass:"mord mathnormal"},[t._v("d")])])])]),t._v(" 时，每层的计算复杂度（complexity per layer）更低：")]),t._v(" "),i("p",[i("img",{attrs:{src:a(549),alt:"complexity"}})])]),t._v(" "),i("li",[i("p",[t._v("更好的并行性，符合目前的硬件（GPU）环境")])]),t._v(" "),i("li",[i("p",[t._v("更好地处理长时依赖问题：如果要处理一个长度为 n 的序列，CNN 需要增加卷积层数来扩大视野，RNN 需要从 1 到 n 逐个进行计算，而 self-attention 只需要一步矩阵运算就可以")])])]),t._v(" "),i("p",[t._v("缺点：")]),t._v(" "),i("ul",[i("li",[i("p",[t._v("但同时从上面那张复杂度表里也能看出来，当句子太长时，Transformer "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("O")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("msup",[i("mi",[t._v("n")]),i("mn",[t._v("2")])],1),i("mo",{attrs:{stretchy:"false"}},[t._v(")")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("O(n^2)")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1.064108em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.02778em"}},[t._v("O")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord"},[i("span",{staticClass:"mord mathnormal"},[t._v("n")]),i("span",{staticClass:"msupsub"},[i("span",{staticClass:"vlist-t"},[i("span",{staticClass:"vlist-r"},[i("span",{staticClass:"vlist",staticStyle:{height:"0.8141079999999999em"}},[i("span",{staticStyle:{top:"-3.063em","margin-right":"0.05em"}},[i("span",{staticClass:"pstrut",staticStyle:{height:"2.7em"}}),i("span",{staticClass:"sizing reset-size6 size3 mtight"},[i("span",{staticClass:"mord mtight"},[t._v("2")])])])])])])])]),i("span",{staticClass:"mclose"},[t._v(")")])])])]),t._v(" 的时间复杂度是非常爆炸的。Transformer 能更好地处理长时依赖问题，但这种复杂度又让它没法处理太长的文本，即使是 Bert 的最大长度也只有 512。")]),t._v(" "),i("p",[t._v("于是出现了一堆致力于解决这个问题的后续工作，等我摸两天鱼再看看有没有空写这个...")])]),t._v(" "),i("li",[i("p",[t._v("扔掉了 RNN 和 CNN，导致失去了捕捉局部特征的能力")]),t._v(" "),i("p",[t._v("不过论文也提到了一个 restricted self-attention（上面那张复杂度表里有），它假设当前词只与前后 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("r")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("r")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.43056em","vertical-align":"0em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.02778em"}},[t._v("r")])])])]),t._v(" 个词有关，因此只在这 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mn",[t._v("2")]),i("mi",[t._v("r")]),i("mo",[t._v("+")]),i("mn",[t._v("1")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("2r+1")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.72777em","vertical-align":"-0.08333em"}}),i("span",{staticClass:"mord"},[t._v("2")]),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.02778em"}},[t._v("r")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}}),i("span",{staticClass:"mbin"},[t._v("+")]),i("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}})]),i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"0.64444em","vertical-align":"0em"}}),i("span",{staticClass:"mord"},[t._v("1")])])])]),t._v(" 个词上做 attention，复杂度是 "),i("span",{staticClass:"katex"},[i("span",{staticClass:"katex-mathml"},[i("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[i("semantics",[i("mrow",[i("mi",[t._v("O")]),i("mo",{attrs:{stretchy:"false"}},[t._v("(")]),i("mi",[t._v("n")]),i("mi",[t._v("r")]),i("mo",{attrs:{stretchy:"false"}},[t._v(")")])],1),i("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("O(nr)")])],1)],1)],1),i("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[i("span",{staticClass:"base"},[i("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.02778em"}},[t._v("O")]),i("span",{staticClass:"mopen"},[t._v("(")]),i("span",{staticClass:"mord mathnormal"},[t._v("n")]),i("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.02778em"}},[t._v("r")]),i("span",{staticClass:"mclose"},[t._v(")")])])])]),t._v("，相当于是在捕捉局部特征。听上去很像卷积窗口？")])]),t._v(" "),i("li",[i("p",[t._v("失去的位置信息非常重要，在词向量中加入 position embedding 这个解决方案依然不够好")])]),t._v(" "),i("li",[i("p",[t._v("非图灵完备（computationally universal）")]),t._v(" "),i("p",[i("a",{attrs:{href:"https://openreview.net/pdf?id=HyzdRiR9Y7",target:"_blank",rel:"noopener noreferrer"}},[i("strong",[t._v("Universal Transformer")])]),t._v(". "),i("em",[t._v("Mostafa Dehghani, et al.")]),t._v(" ICLR 2019.")])])]),t._v(" "),i("h2",{attrs:{id:"reference"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#reference"}},[t._v("#")]),t._v(" Reference")]),t._v(" "),i("ul",[i("li",[i("p",[t._v("图解 Transformer："),i("a",{attrs:{href:"http://jalammar.github.io/illustrated-transformer/",target:"_blank",rel:"noopener noreferrer"}},[t._v("The Illustrated Transformer")])])]),t._v(" "),i("li",[i("p",[t._v("连着代码一起讲："),i("a",{attrs:{href:"http://nlp.seas.harvard.edu/2018/04/03/attention.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("The Annotated Transformer")])])]),t._v(" "),i("li",[i("p",[i("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/44121378",target:"_blank",rel:"noopener noreferrer"}},[t._v("【NLP】Transformer 详解")])])]),t._v(" "),i("li",[i("p",[i("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/48508221",target:"_blank",rel:"noopener noreferrer"}},[t._v("详解 Transformer（Attention Is All You Need）")])])])])])}),[],!1,null,null,null);s.default=e.exports}}]);